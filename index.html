<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Osama Meter — Fixed</title>

<style>
:root{
  --bg:#050607;
  --white:#ffffff;
  --green:#28ff8b;
  --amber:#ffcc66;
  --red:#ff3b3b;

  --panel:#0b0f15;
  --line:#1c2026;

  --topbar:#3a0b0b; /* dark red */
  --glow-g:rgba(40,255,139,.45);
  --glow-r:rgba(255,59,59,.45);
}

*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  background:radial-gradient(circle at 50% 20%, #0c1016, #040506 70%);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  color:var(--white);
  display:flex;
  justify-content:center;
}

/* ===== FRAME ===== */
.dashboard{
  width:min(480px,100%);
  min-height:100vh;
  background:linear-gradient(180deg,#07090d,#030405);
  display:grid;
  grid-template-rows:auto 1fr auto;
}

/* ===== TOP BAR (safe area aware) ===== */
.topbar{
  background:var(--topbar);
  padding:12px 16px;
  padding-top:calc(12px + env(safe-area-inset-top));
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  border-bottom:1px solid rgba(255,255,255,.08);
}

.topbar .left{
  font-weight:900;
  letter-spacing:.16em;
  white-space:nowrap;
}
.topbar .right{
  display:flex;
  align-items:center;
  gap:14px;
  font-size:12px;
  white-space:nowrap;
}
.topbar .right .active{
  color:var(--green);
}
.topbar .right .muted{
  opacity:.9;
  color:#fff;
}

/* ===== MAIN ===== */
.main{
  padding:18px;
  padding-bottom:18px;
  display:grid;
  grid-template-columns:1.2fr .8fr;
  gap:18px;
}

/* ===== SPEED CORE ===== */
.speed-core{
  background:var(--panel);
  border:1px solid rgba(255,255,255,.06);
  border-radius:22px;
  padding:20px;
  display:grid;
  grid-template-rows:auto auto auto;
  align-items:center;
}

.speed{
  font-size:92px;
  font-weight:950;
  text-align:center;
  letter-spacing:.10em;
  line-height:1;
}
.unit{
  text-align:center;
  font-size:12px;
  letter-spacing:.3em;
  opacity:.85;
}

/* ===== RADAR GAUGE ===== */
.gauge{
  width:250px;
  margin:12px auto 0;
  display:block;
}
.track{
  stroke:#222;
  stroke-width:10;
  fill:none;
}
.progress{
  stroke:url(#grad);
  stroke-width:10;
  fill:none;
  stroke-linecap:round;
  stroke-dasharray:0 314; /* init */
}
.needle{
  transform-origin:120px 120px; /* IMPORTANT */
}
.needle line{
  stroke:#fff;
  stroke-width:4;
  filter:drop-shadow(0 0 6px rgba(255,255,255,.25));
}
.needle circle{ fill:#fff; }

/* ===== INFO ===== */
.info{
  display:grid;
  gap:16px;
}
.box{
  background:var(--panel);
  border:1px solid rgba(255,255,255,.06);
  border-radius:16px;
  padding:14px;
}
.label{
  font-size:11px;
  opacity:.65;
  letter-spacing:.12em;
}
.value{
  margin-top:8px;
  font-size:28px;
  font-weight:900;
  color:var(--amber);
  letter-spacing:.08em;
}

/* ===== FOOTER BUTTONS ===== */
.footer{
  padding:14px 18px;
  padding-bottom:calc(14px + env(safe-area-inset-bottom));
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px;
  border-top:1px solid rgba(255,255,255,.06);
  background:rgba(0,0,0,.15);
}
button{
  border:none;
  border-radius:16px;
  padding:14px;
  font-weight:900;
  letter-spacing:.12em;
  background:#222;
  color:#fff;
}
button.active.lock{
  background:var(--green);
  color:#000;
  box-shadow:0 0 18px var(--glow-g);
}
button.active.hazard{
  background:var(--red);
  color:#000;
  box-shadow:0 0 18px var(--glow-r);
}

.hint{
  padding:0 18px 12px;
  font-size:12px;
  opacity:.8;
}
</style>
</head>

<body>

<div class="dashboard">

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="left">OSAMA&nbsp;METER</div>
    <div class="right">
      <span class="muted" id="clock">--:--</span>
      <span class="muted" id="battery">--%</span>
      <span class="active" id="gpsState">GPS</span>
      <span class="muted" id="gpsRaw">0</span>
    </div>
  </div>

  <div class="hint" id="hint">
    ملاحظة: GPS يحتاج HTTPS + سماح Location. إذا رفضت الإذن، سيبقى على N.
  </div>

  <!-- MAIN -->
  <div class="main">

    <div class="speed-core">
      <div class="speed" id="speed">N</div>
      <div class="unit">KM / H</div>

      <svg class="gauge" viewBox="0 0 240 140" aria-hidden="true">
        <defs>
          <linearGradient id="grad">
            <stop offset="0%" stop-color="#28ff8b"/>
            <stop offset="70%" stop-color="#ffcc66"/>
            <stop offset="100%" stop-color="#ff3b3b"/>
          </linearGradient>
        </defs>

        <path class="track" d="M20 120 A100 100 0 0 1 220 120"/>
        <path class="progress" id="arc" d="M20 120 A100 100 0 0 1 220 120"/>

        <!-- Needle starts from RIGHT at 0 speed -->
        <g class="needle" id="needle">
          <line x1="120" y1="120" x2="220" y2="120"/>
          <circle cx="120" cy="120" r="6"/>
        </g>
      </svg>
    </div>

    <div class="info">
      <div class="box">
        <div class="label">GEAR</div>
        <div class="value" id="gear">G1</div>
      </div>

      <div class="box">
        <div class="label">GPS SPEED</div>
        <div class="value" id="gpsSpeed">0</div>
      </div>
    </div>

  </div>

  <!-- FOOTER -->
  <div class="footer">
    <button id="lockBtn" type="button">SCREEN LOCK</button>
    <button id="hazardBtn" type="button">HAZARD</button>
  </div>

</div>

<script>
(() => {
  "use strict";

  /* ===== DOM ===== */
  const elSpeed = document.getElementById("speed");
  const elGear = document.getElementById("gear");
  const elGpsSpeed = document.getElementById("gpsSpeed");
  const elGpsRaw = document.getElementById("gpsRaw");
  const elGpsState = document.getElementById("gpsState");
  const elBattery = document.getElementById("battery");
  const elClock = document.getElementById("clock");
  const elHint = document.getElementById("hint");

  const needle = document.getElementById("needle");
  const arc = document.getElementById("arc");

  const lockBtn = document.getElementById("lockBtn");
  const hazardBtn = document.getElementById("hazardBtn");

  /* ===== CONFIG ===== */
  const MAX_SPEED = 120;     // scale end
  const ARC_LEN = 314;       // tuned for our arc path
  const LERP = 0.16;         // UI smooth follow

  /* ===== STATE ===== */
  let realSpeed = 0;         // km/h (raw from GPS)
  let displaySpeed = 0;      // smoothed for UI
  let wakeOn = false;
  let hazardOn = false;

  let wakeLock = null;

  /* ===== HELPERS ===== */
  const clamp01 = (x) => Math.max(0, Math.min(1, x));

  function resolveGear(v){
    // as per your earlier rules
    if (v <= 10) return "G1";
    if (v <= 15) return "G2";
    if (v <= 20) return "G3";
    if (v <= 25) return "G4";
    if (v <= 30) return "G5";
    return "G5";
  }

  function setNeedleAndArc(speed){
    const ratio = clamp01(speed / MAX_SPEED);

    // Needle starts at RIGHT (0 deg) and moves toward LEFT (-180 deg)
    const angleDeg = -ratio * 180;
    needle.style.transform = `rotate(${angleDeg}deg)`;

    const drawn = ARC_LEN * ratio;
    arc.style.strokeDasharray = `${drawn} ${ARC_LEN}`;
  }

  /* ===== CLOCK ===== */
  function updateClock(){
    const d = new Date();
    elClock.textContent = d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  }
  updateClock();
  setInterval(updateClock, 1000);

  /* ===== BATTERY ===== */
  async function initBattery(){
    if (!("getBattery" in navigator)){
      elBattery.textContent = "N/A";
      return;
    }
    try{
      const b = await navigator.getBattery();
      const u = () => { elBattery.textContent = Math.round(b.level * 100) + "%"; };
      u();
      b.addEventListener("levelchange", u);
      b.addEventListener("chargingchange", u);
    }catch{
      elBattery.textContent = "N/A";
    }
  }
  initBattery();

  /* ===== GPS ===== */
  function initGPS(){
    if (!("geolocation" in navigator)){
      elGpsState.textContent = "NO GPS";
      elGpsState.classList.remove("active");
      elHint.textContent = "جهازك لا يدعم GPS داخل المتصفح.";
      return;
    }

    elGpsState.textContent = "GPS";
    elGpsState.classList.add("active");

    navigator.geolocation.watchPosition(
      (pos) => {
        const s = pos.coords.speed;
        if (typeof s === "number" && isFinite(s) && s >= 0){
          realSpeed = s * 3.6;
          elGpsSpeed.textContent = String(Math.round(realSpeed));
          elGpsRaw.textContent = String(Math.round(realSpeed));
          elGpsState.textContent = "GPS OK";
          elGpsState.classList.add("active");
        }
      },
      (err) => {
        elGpsState.textContent = "GPS ERR";
        elGpsState.classList.remove("active");
        elHint.textContent =
          "GPS لا يعمل: تأكد أنك على HTTPS وفعّلت إذن الموقع Location. (" + err.message + ")";
      },
      { enableHighAccuracy: true, maximumAge: 250, timeout: 8000 }
    );
  }
  initGPS();

  /* ===== WAKE LOCK (Screen Lock button) ===== */
  async function enableWake(){
    if (!("wakeLock" in navigator)){
      elHint.textContent = "Wake Lock غير مدعوم في هذا المتصفح.";
      return false;
    }
    try{
      wakeLock = await navigator.wakeLock.request("screen");
      wakeLock.addEventListener("release", () => {
        wakeLock = null;
        wakeOn = false;
        lockBtn.classList.remove("active","lock");
      });
      return true;
    }catch(e){
      elHint.textContent = "لم أستطع تفعيل Wake Lock: " + e.message;
      return false;
    }
  }

  async function toggleWake(){
    if (!wakeOn){
      const ok = await enableWake();
      if (ok){
        wakeOn = true;
        lockBtn.classList.add("active","lock");
      }
    }else{
      try{ await wakeLock?.release(); }catch{}
      wakeLock = null;
      wakeOn = false;
      lockBtn.classList.remove("active","lock");
    }
  }

  document.addEventListener("visibilitychange", async () => {
    if (!document.hidden && wakeOn && !wakeLock){
      await enableWake();
    }
  }, { passive:true });

  lockBtn.addEventListener("click", toggleWake, { passive:true });

  /* ===== HAZARD button (UI state only) ===== */
  function toggleHazard(){
    hazardOn = !hazardOn;
    hazardBtn.classList.toggle("active", hazardOn);
    hazardBtn.classList.toggle("hazard", hazardOn);
    // (إذا تريد فلاش فعلي لاحقًا، نضيف TORCH هنا)
  }
  hazardBtn.addEventListener("click", toggleHazard, { passive:true });

  /* ===== RENDER LOOP ===== */
  function loop(){
    // smooth follow
    displaySpeed += (realSpeed - displaySpeed) * LERP;
    if (displaySpeed < 0.2) displaySpeed = 0;

    const shown = Math.round(displaySpeed);
    elSpeed.textContent = (shown === 0) ? "N" : String(shown);
    elGear.textContent = resolveGear(shown);

    setNeedleAndArc(displaySpeed);

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
})();
</script>

</body>
</html>
