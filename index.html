<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Osama Meter</title>

<style>
:root{
  --bg:#000;
  --text:#f2f6ff;
  --muted:#9aa3b2;
  --green:#1cff9a;
  --red:#ff2a4f;
  --amber:#ffd166;
}

*{box-sizing:border-box}
html,body{height:100%}

body{
  margin:0;
  background:#000;
  color:var(--text);
  font-family:system-ui,Segoe UI,Roboto,Arial;
  display:grid;
  place-items:center;
}

.frame{
  width:min(560px,96vw);
  padding:14px;
  border-radius:16px;
  border:2px solid #1a1a1a;
  box-shadow:0 25px 60px rgba(0,0,0,.9);
}

.frame.hid{
  box-shadow:0 0 25px var(--red), 0 0 60px rgba(255,42,79,.8);
}

.top{
  text-align:center;
  margin-bottom:8px;
}
.title{
  font-size:18px;
  font-weight:900;
}
.subtitle{
  font-size:14px;
  color:var(--muted);
}

.gauge{
  position:relative;
  width:100%;
  aspect-ratio:1/1;
}

.arc{
  position:absolute;
  inset:10%;
  border-radius:50%;
  background:conic-gradient(from 225deg,
    var(--green) 0deg,
    var(--amber) 180deg,
    var(--red) 260deg,
    transparent 0deg);
  mask:radial-gradient(circle,transparent 62%,black 63%);
}

.cut{
  position:absolute;
  inset:0;
  border-radius:50%;
  background:radial-gradient(circle at 50% 108%,#000 57%,transparent 59%);
}

.needle{
  position:absolute;
  width:45%;
  height:4px;
  left:50%;
  top:50%;
  transform-origin:0% 50%;
  background:linear-gradient(90deg,#fff,#ff2a4f);
}

.inner{
  position:absolute;
  inset:30%;
  border-radius:50%;
  background:#000;
  display:grid;
  place-items:center;
  text-align:center;
}

.speed{
  font-size:48px;
  font-weight:900;
}

.gear{
  font-size:22px;
  color:var(--amber);
  font-weight:800;
}

.unit{
  font-size:12px;
  color:var(--muted);
}

.controls{
  display:flex;
  justify-content:space-between;
  margin-top:10px;
}

button{
  background:#000;
  border:2px solid #333;
  color:#fff;
  padding:8px 12px;
  font-weight:700;
}
</style>
</head>

<body>
<div class="frame" id="frame">
  <div class="top">
    <div class="title">Osama Meter</div>
    <div class="subtitle">دراجة عبد الحليم</div>
  </div>

  <div class="gauge">
    <div class="arc"></div>
    <div class="needle" id="needle"></div>
    <div class="inner">
      <div>
        <div class="speed" id="speed">0</div>
        <div class="gear" id="gear">G1</div>
        <div class="unit">km/h</div>
      </div>
    </div>
    <div class="cut"></div>
  </div>

  <div class="controls">
    <button id="hazardBtn">Hazard OFF</button>
    <button id="wakeBtn">Screen ON</button>
  </div>
</div>

<script>
/* ================== CONFIG ================== */
const START=225, SWEEP=270;
const MAX_ACC=30, STOP_KMH=2, STOP_MS=1500, EMA=0.22;

/* ================== STATE ================== */
let last=null, ema=0, stopSince=null;
let hazard=false, torchTrack=null, hazardTimer=null;
let audioCtx=null, beepOsc=null;

/* ================== ELEMENTS ================== */
const needle=document.getElementById("needle");
const speedTxt=document.getElementById("speed");
const gearTxt=document.getElementById("gear");
const frame=document.getElementById("frame");

/* ================== HELPERS ================== */
const rad=d=>d*Math.PI/180;
const hav=(a,b,c,d)=>{
  const R=6371000;
  const dLat=rad(c-a), dLon=rad(d-b);
  return 2*R*Math.asin(Math.sqrt(
    Math.sin(dLat/2)**2+
    Math.cos(rad(a))*Math.cos(rad(c))*Math.sin(dLon/2)**2
  ));
};

function gearFromSpeed(v){
  if(v<=10) return "G1";
  if(v<=15) return "G2";
  if(v<=20) return "G3";
  if(v<=25) return "G4";
  return "G5";
}

function setGauge(v){
  speedTxt.textContent=Math.round(v);
  gearTxt.textContent=gearFromSpeed(v);
  needle.style.transform=
    `translateY(-50%) rotate(${START+(v/60)*SWEEP}deg)`;
}

/* ================== BEEP ================== */
function startBeep(){
  if(audioCtx) return;
  audioCtx=new AudioContext();
  beepOsc=audioCtx.createOscillator();
  beepOsc.frequency.value=900;
  beepOsc.connect(audioCtx.destination);
  beepOsc.start();
}
function stopBeep(){
  if(beepOsc){beepOsc.stop();beepOsc=null;}
  audioCtx=null;
}

/* ================== FLASHLIGHT ================== */
async function toggleHazard(){
  hazard=!hazard;
  document.getElementById("hazardBtn").textContent=hazard?"Hazard ON":"Hazard OFF";
  if(!hazard){
    clearInterval(hazardTimer);
    if(torchTrack) torchTrack.applyConstraints({advanced:[{torch:false}]});
    return;
  }
  const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  torchTrack=stream.getVideoTracks()[0];
  hazardTimer=setInterval(()=>{
    torchTrack.applyConstraints({advanced:[{torch:true}]});
    setTimeout(()=>torchTrack.applyConstraints({advanced:[{torch:false}]}),300);
  },600);
}

/* ================== WAKE LOCK ================== */
let wakeLock=null;
async function keepAwake(){
  if("wakeLock" in navigator){
    wakeLock=await navigator.wakeLock.request("screen");
  }
}
document.getElementById("wakeBtn").onclick=keepAwake;
document.getElementById("hazardBtn").onclick=toggleHazard;

/* ================== GPS ================== */
navigator.geolocation.watchPosition(p=>{
  const {latitude,longitude,accuracy,speed}=p.coords;
  const t=p.timestamp;
  if(accuracy>MAX_ACC) return;

  let kmh=null;
  if(speed!=null) kmh=speed*3.6;
  else if(last){
    const d=hav(last.lat,last.lon,latitude,longitude);
    const dt=(t-last.t)/1000;
    if(dt>0) kmh=(d/dt)*3.6;
  }
  last={lat:latitude,lon:longitude,t};
  if(kmh==null) return;

  ema=EMA*kmh+(1-EMA)*ema;

  if(ema>25){
    frame.classList.add("hid");
    startBeep();
  }else{
    frame.classList.remove("hid");
    stopBeep();
  }

  setGauge(ema);
},
()=>{},
{enableHighAccuracy:true,maximumAge:250,timeout:8000});
</script>
</body>
</html>
