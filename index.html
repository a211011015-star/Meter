<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Osama Meter</title>

  <style>
    :root{
      --bg:#000;
      --fg:#eaf0ff;
      --muted:#90a0b8;
      --danger:#ff2a4f;
      --ok:#1cff9a;
      --line:#1b1b1b;

      /* Digital glow */
      --glow: rgba(234,240,255,.28);
      --glow-strong: rgba(234,240,255,.55);
      --glow-red: rgba(255,42,79,.45);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }
    body{
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* =========================
       DIGITAL LOOK (GLOBAL)
       ========================= */
    .digital{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      letter-spacing: .06em;
      text-transform: uppercase;
      font-variant-numeric: tabular-nums;
      -webkit-font-smoothing: antialiased;
      text-rendering: geometricPrecision;
    }

    /* “Lit segments” effect */
    .digital-lit{
      color: var(--fg);
      text-shadow:
        0 0 10px var(--glow),
        0 0 22px rgba(234,240,255,.18),
        0 0 36px rgba(234,240,255,.10);
      -webkit-text-stroke: 0.35px rgba(234,240,255,.18);
    }

    /* Unlit “ghost segments” behind the text */
    .digital-ghost{
      position: relative;
      display: inline-block;
    }
    .digital-ghost::before{
      content: attr(data-ghost);
      position:absolute;
      inset: 0;
      color: rgba(234,240,255,.06);
      text-shadow: none;
      -webkit-text-stroke: 0;
      transform: translate(0, 0);
      pointer-events:none;
    }
    .digital-ghost > span{
      position: relative;
      z-index: 1;
    }

    /* Wrapper */
    .screen{
      width:min(440px, 96vw);
      height:min(860px, 96vh);
      border:2px solid #111;
      border-radius:18px;
      padding:18px;
      position:relative;
      background:#000;
      box-shadow: 0 18px 60px rgba(0,0,0,.75);
    }

    .screen.hid{
      border-color: rgba(255,42,79,.85);
      box-shadow:
        0 0 22px var(--glow-red),
        0 0 70px rgba(255,42,79,.20),
        0 18px 60px rgba(0,0,0,.75);
    }

    /* Header */
    .header{
      text-align:center;
      padding-top:6px;
      padding-bottom:12px;
      border-bottom:1px solid var(--line);
    }
    .title{
      font-weight:900;
      font-size:18px;
      margin:0;
    }
    .subtitle{
      margin:6px 0 0;
      color: var(--muted);
      font-size:14px;
      letter-spacing: .08em;
    }

    /* Main block */
    .main{
      height: calc(100% - 120px);
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:18px;
      padding:18px 6px;
    }

    /* Big speed */
    .speedWrap{
      width:100%;
      border:1px solid var(--line);
      border-radius:16px;
      padding:18px 14px;
      text-align:center;
      background: radial-gradient(600px 220px at 50% 20%, rgba(234,240,255,.05), transparent 60%);
    }

    .speed{
      font-weight:900;
      font-size:92px;
      line-height:1;
      letter-spacing:.10em;
    }

    .unit{
      margin-top:6px;
      font-size:14px;
      letter-spacing: .28em;
      color: var(--muted);
    }

    /* Gear row */
    .row{
      width:100%;
      display:flex;
      gap:12px;
    }

    .card{
      flex:1;
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px 12px;
      background:#000;
    }

    .label{
      font-size:12px;
      letter-spacing:.22em;
      color: var(--muted);
      text-transform:uppercase;
    }

    .gear{
      margin-top:6px;
      font-weight:900;
      font-size:44px;
      color: var(--danger);
      text-shadow:
        0 0 10px rgba(255,42,79,.22),
        0 0 22px rgba(255,42,79,.12);
      letter-spacing:.10em;
    }

    /* Battery */
    .batteryWrap{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:6px;
    }
    .batteryPct{
      font-weight:900;
      font-size:18px;
      letter-spacing:.10em;
    }
    .batteryBarOuter{
      width:140px;
      height:14px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:2px;
      overflow:hidden;
    }
    .batteryBar{
      height:100%;
      width:0%;
      background: var(--fg);
      border-radius:999px;
      transition: width .2s linear;
      box-shadow: 0 0 16px rgba(234,240,255,.12);
    }

    /* Status + controls */
    .footer{
      position:absolute;
      left:18px;
      right:18px;
      bottom:16px;
      border-top:1px solid var(--line);
      padding-top:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .statusLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      font-size:12px;
      letter-spacing:.14em;
    }

    .dot{
      width:10px;height:10px;border-radius:50%;
      background:#333;
      display:inline-block;
      margin-inline-end:8px;
    }
    .dot.ok{ background: var(--ok); box-shadow:0 0 16px rgba(28,255,154,.25); }
    .dot.warn{ background: #ffd166; box-shadow:0 0 16px rgba(255,209,102,.18); }
    .dot.bad{ background: var(--danger); box-shadow:0 0 16px rgba(255,42,79,.22); }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    button{
      appearance:none;
      border:1px solid var(--line);
      background:#050505;
      color: var(--fg);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      letter-spacing:.10em;
      cursor:pointer;
      flex:1;
      min-width: 140px;
    }
    button:disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    .hint{
      font-size:11px;
      color: var(--muted);
      line-height:1.45;
      letter-spacing:.06em;
    }

    @media (max-height: 720px){
      .speed{ font-size:78px; }
      .gear{ font-size:40px; }
    }
  </style>
</head>

<body>
  <div class="screen" id="screen">
    <div class="header digital digital-lit">
      <h1 class="title">Osama Meter</h1>
      <p class="subtitle">دراجة عبد الحليم</p>
    </div>

    <div class="main">
      <div class="speedWrap">
        <!-- ghost segments: show "88" style background -->
        <div class="digital digital-lit digital-ghost speed" id="speedGhost" data-ghost="88">
          <span id="speed">--</span>
        </div>
        <div class="digital unit" id="unit">KM/H</div>
      </div>

      <div class="row">
        <div class="card">
          <div class="digital label">GEAR</div>
          <div class="digital gear digital-ghost" id="gearGhost" data-ghost="G8">
            <span id="gear">-</span>
          </div>
        </div>

        <div class="card">
          <div class="digital label">BATTERY</div>
          <div class="batteryWrap">
            <div class="digital batteryPct digital-ghost" id="batteryPctGhost" data-ghost="100%">
              <span id="batteryPct">--%</span>
            </div>
            <div class="batteryBarOuter" aria-label="Battery level">
              <div class="batteryBar" id="batteryBar"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="width:100%;">
        <div class="digital label">ALERT</div>
        <div class="digital" style="margin-top:8px; color:var(--muted); font-size:13px; letter-spacing:.08em;">
          ABOVE <b>25</b> KM/H: BEEP + HID HIGHLIGHT
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="statusLine digital">
        <div>
          <span class="dot warn" id="dot"></span>
          <span id="status">طلب صلاحية GPS…</span>
        </div>
        <div id="acc">ACC: -- M</div>
      </div>

      <div class="btnRow">
        <button class="digital" id="wakeBtn" type="button">KEEP SCREEN ON: OFF</button>
        <button class="digital" id="hazardBtn" type="button">HAZARD: OFF</button>
      </div>

      <div class="hint digital" id="hint">
        ملاحظة: قد يتطلب تشغيل الصوت/التنبيه ضغطة زر مرة واحدة. الفلاش يعمل فقط إذا الجهاز يدعم TORCH ومع HTTPS.
      </div>
    </div>
  </div>

  <script>
    // =============================
    // CONFIG (tuned for mobile stability)
    // =============================
    const MAX_ACC_M = 30;          // ignore noisy fixes
    const EMA_ALPHA = 0.22;        // smoothing
    const STOP_SPEED_KMH = 2.0;    // stop threshold
    const STOP_HOLD_MS = 1400;     // snap to 0 after stable stop
    const ALERT_SPEED_KMH = 25.0;  // beep + HID above this

    // =============================
    // UI elements
    // =============================
    const screen = document.getElementById("screen");
    const speedEl = document.getElementById("speed");
    const gearEl = document.getElementById("gear");
    const statusEl = document.getElementById("status");
    const dotEl = document.getElementById("dot");
    const accEl = document.getElementById("acc");
    const batteryPctEl = document.getElementById("batteryPct");
    const batteryBarEl = document.getElementById("batteryBar");
    const wakeBtn = document.getElementById("wakeBtn");
    const hazardBtn = document.getElementById("hazardBtn");

    // =============================
    // State
    // =============================
    let emaSpeed = 0;
    let stopSince = null;

    // Beep state
    let audioCtx = null;
    let beepTimer = null;

    // Wake lock state
    let wakeLock = null;
    let wakeOn = false;

    // Hazard (torch) state
    let hazardOn = false;
    let hazardInterval = null;
    let torchTrack = null;
    let torchSupported = false;

    // =============================
    // Helpers
    // =============================
    function setStatus(kind, text){
      statusEl.textContent = text;
      dotEl.className = "dot " + kind;
    }

    function gearFromSpeedKmh(v){
      // EXACT rules requested
      if (v <= 10) return "G1";
      if (v <= 15) return "G2";
      if (v <= 20) return "G3";
      if (v <= 25) return "G4";
      if (v <= 30) return "G5";
      return "G5";
    }

    function updateUI(speedKmh, accuracy){
      if (Number.isFinite(accuracy)) accEl.textContent = "ACC: " + Math.round(accuracy) + " M";
      else accEl.textContent = "ACC: -- M";

      if (!Number.isFinite(speedKmh)){
        speedEl.textContent = "--";
        gearEl.textContent = "-";
        return;
      }

      speedEl.textContent = String(Math.round(speedKmh));
      gearEl.textContent = gearFromSpeedKmh(speedKmh);
    }

    // =============================
    // Beep-Beep (WebAudio)
    // =============================
    function ensureAudio(){
      if (audioCtx) return;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }

    function playBeepOnce(){
      ensureAudio();
      const now = audioCtx.currentTime;

      const gain = audioCtx.createGain();
      gain.gain.setValueAtTime(0.0001, now);
      gain.connect(audioCtx.destination);

      const osc = audioCtx.createOscillator();
      osc.type = "sine";
      osc.frequency.setValueAtTime(950, now);
      osc.connect(gain);

      // beep 1
      gain.gain.exponentialRampToValueAtTime(0.18, now + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.12);

      // beep 2
      gain.gain.setValueAtTime(0.0001, now + 0.21);
      gain.gain.exponentialRampToValueAtTime(0.18, now + 0.22);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.33);

      osc.start(now);
      osc.stop(now + 0.40);

      osc.onended = () => {
        try { osc.disconnect(); } catch(e){}
        try { gain.disconnect(); } catch(e){}
      };
    }

    function startAlarm(){
      if (beepTimer) return;
      try { playBeepOnce(); } catch(e) {}
      beepTimer = setInterval(() => {
        try { playBeepOnce(); } catch(e) {}
      }, 1200);
    }

    function stopAlarm(){
      if (beepTimer){
        clearInterval(beepTimer);
        beepTimer = null;
      }
      if (audioCtx){
        try { audioCtx.close(); } catch(e){}
        audioCtx = null;
      }
    }

    // =============================
    // HID highlight (visual alert)
    // =============================
    function setHid(on){
      if (on) screen.classList.add("hid");
      else screen.classList.remove("hid");
    }

    // =============================
    // Wake Lock
    // =============================
    async function enableWakeLock(){
      if (!("wakeLock" in navigator)) {
        setStatus("warn", "WAKE LOCK غير مدعوم.");
        return false;
      }
      try {
        wakeLock = await navigator.wakeLock.request("screen");
        wakeLock.addEventListener("release", () => {
          wakeLock = null;
          wakeOn = false;
          wakeBtn.textContent = "KEEP SCREEN ON: OFF";
        });
        return true;
      } catch (e){
        setStatus("warn", "فشل WAKE LOCK.");
        return false;
      }
    }

    async function toggleWake(){
      // user gesture -> helps unlock audio too
      if (!wakeOn){
        const ok = await enableWakeLock();
        if (ok){
          wakeOn = true;
          wakeBtn.textContent = "KEEP SCREEN ON: ON";
        }
      } else {
        if (wakeLock){
          try { await wakeLock.release(); } catch(e){}
          wakeLock = null;
        }
        wakeOn = false;
        wakeBtn.textContent = "KEEP SCREEN ON: OFF";
      }
    }

    document.addEventListener("visibilitychange", async () => {
      if (!document.hidden && wakeOn && !wakeLock){
        await enableWakeLock();
      }
    });

    wakeBtn.addEventListener("click", toggleWake);

    // =============================
    // Battery indicator
    // =============================
    async function initBattery(){
      if (!("getBattery" in navigator)){
        batteryPctEl.textContent = "N/A";
        batteryBarEl.style.width = "0%";
        return;
      }
      try{
        const b = await navigator.getBattery();
        const update = () => {
          const pct = Math.round(b.level * 100);
          batteryPctEl.textContent = pct + "%";
          batteryBarEl.style.width = pct + "%";
          if (pct <= 15) batteryBarEl.style.background = "var(--danger)";
          else if (pct <= 35) batteryBarEl.style.background = "#ffd166";
          else batteryBarEl.style.background = "var(--fg)";
        };
        update();
        b.addEventListener("levelchange", update);
        b.addEventListener("chargingchange", update);
      } catch(e){
        batteryPctEl.textContent = "N/A";
      }
    }

    // =============================
    // Hazard Torch (flashlight)
    // =============================
    async function detectTorchSupport(){
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return false;
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } }});
        const track = stream.getVideoTracks()[0];
        const caps = track.getCapabilities ? track.getCapabilities() : {};
        const hasTorch = !!caps.torch;

        track.stop();
        stream.getTracks().forEach(t => t.stop());
        return hasTorch;
      } catch(e){
        return false;
      }
    }

    async function setTorch(on){
      if (!torchTrack) return;
      await torchTrack.applyConstraints({ advanced: [{ torch: !!on }] });
    }

    async function startHazard(){
      if (!torchSupported) return;
      if (hazardInterval) return;

      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" } }
      });
      torchTrack = stream.getVideoTracks()[0];

      let state = false;
      hazardInterval = setInterval(async () => {
        try{
          state = !state;
          await setTorch(state);
        } catch(e){}
      }, 500);
    }

    async function stopHazard(){
      if (hazardInterval){
        clearInterval(hazardInterval);
        hazardInterval = null;
      }
      if (torchTrack){
        try { await setTorch(false); } catch(e){}
        try { torchTrack.stop(); } catch(e){}
        torchTrack = null;
      }
    }

    async function toggleHazard(){
      // user gesture helps audio too
      if (!torchSupported){
        setStatus("warn", "TORCH غير مدعوم.");
        hazardBtn.disabled = true;
        return;
      }

      hazardOn = !hazardOn;
      hazardBtn.textContent = hazardOn ? "HAZARD: ON" : "HAZARD: OFF";

      if (hazardOn) {
        try { await startHazard(); }
        catch(e){
          setStatus("warn", "فشل تشغيل الفلاش.");
          hazardOn = false;
          hazardBtn.textContent = "HAZARD: OFF";
        }
      } else {
        await stopHazard();
      }
    }

    hazardBtn.addEventListener("click", toggleHazard);

    // =============================
    // GPS Speed (stable)
    // =============================
    function initGPS(){
      if (!("geolocation" in navigator)){
        setStatus("bad", "GPS غير مدعوم.");
        updateUI(NaN, NaN);
        return;
      }

      setStatus("warn", "طلب صلاحية GPS…");

      navigator.geolocation.watchPosition(
        (pos) => {
          const { speed, accuracy } = pos.coords;

          if (Number.isFinite(accuracy)) accEl.textContent = "ACC: " + Math.round(accuracy) + " M";

          if (Number.isFinite(accuracy) && accuracy > MAX_ACC_M){
            setStatus("warn", "GPS ضعيف…");
            updateUI(emaSpeed, accuracy);
            return;
          }

          let rawKmh = null;
          if (typeof speed === "number" && isFinite(speed) && speed >= 0){
            rawKmh = speed * 3.6;
          } else {
            setStatus("warn", "GPS…");
            updateUI(emaSpeed, accuracy);
            return;
          }

          // EMA smoothing
          emaSpeed = EMA_ALPHA * rawKmh + (1 - EMA_ALPHA) * emaSpeed;

          // Stop hysteresis
          const tMs = pos.timestamp;
          if (emaSpeed < STOP_SPEED_KMH){
            if (stopSince === null) stopSince = tMs;
            if ((tMs - stopSince) >= STOP_HOLD_MS) emaSpeed = 0;
          } else {
            stopSince = null;
          }

          setStatus("ok", "GPS ACTIVE");
          updateUI(emaSpeed, accuracy);

          const alertOn = emaSpeed > ALERT_SPEED_KMH;
          setHid(alertOn);
          if (alertOn) startAlarm();
          else stopAlarm();
        },
        (err) => {
          console.error(err);
          setStatus("bad", "GPS ERROR");
          updateUI(NaN, NaN);
          stopAlarm();
          setHid(false);
        },
        { enableHighAccuracy: true, maximumAge: 250, timeout: 8000 }
      );
    }

    // =============================
    // Init
    // =============================
    (async function init(){
      await initBattery();
      torchSupported = await detectTorchSupport();
      if (!torchSupported){
        hazardBtn.disabled = true;
        hazardBtn.textContent = "HAZARD: N/A";
      }
      initGPS();
    })();

    window.addEventListener("beforeunload", async () => {
      try { await stopHazard(); } catch(e){}
      try { stopAlarm(); } catch(e){}
    });
  </script>
</body>
</html>
